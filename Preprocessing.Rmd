---
title: "Preprocessing"
author: "FERRAN ARMENGOL Y SALOMÓN SABAL"
date: "2025-10-06"
output:
  pdf_document: default
  html_document: default
---
Preprocessing univariante
```{r}
#install.packages("dplyr")
library(dplyr)
```

```{r}
train <- read.csv("train.csv", header = TRUE, sep = ",")
test  <- read.csv("test.csv", header = TRUE, sep = ",")
datos <- bind_rows(train, test)

dim(datos)       
head(datos)       
summary(datos)   
clases <- sapply(datos, class)
datos$HasCrCard <- as.factor(datos$HasCrCard)
datos$IsActiveMember <- as.factor(datos$IsActiveMember)
datos$SavingsAccountFlag <- as.factor(datos$SavingsAccountFlag)


varNum <- names(datos)[sapply(datos, is.numeric)]
varCat <- names(datos)[!sapply(datos, is.numeric)]

```

```{r}
#install.packages("dlookr")
library(dlookr)
dlookr::diagnose(datos)
```
```{r}
head(overview(datos), n = 9)
```

```{r}
diagnose_numeric(datos)
```

```{r}
diagnose_category(datos)
```
```{r}
mapply(function(x, name) {
  if (is.numeric(x)) {
    cat("var. ", name, ": \n\t min: ", min(x, na.rm = TRUE), "\n\t max: ", max(x, na.rm = TRUE), "\n")
  }
  invisible(NULL)
}, datos[, varNum], colnames(datos[, varNum]))

```

```{r}
library(EnvStats)

IQROutlier <- function(variable, rmnas = TRUE) {
  variable <- variable[!is.na(variable)]  # eliminar NAs
  IQ <- iqr(variable, na.rm = rmnas)
  intInf <- quantile(variable, probs = 0.25, na.rm = TRUE) - 1.5 * IQ
  intSup <- quantile(variable, probs = 0.75, na.rm = TRUE) + 1.5 * IQ
  posicions <- which(variable >= intSup | variable <= intInf)
  if (length(posicions) > 0) {
    cat("Existeixen outliers en les posicions:", paste0(posicions, collapse = ", "))
  } else {
    cat("No existeixen outliers")
  }
  return(posicions)
}

outliers_todos <- lapply(varNum, function(v) {
  cat("\n\nVariable:", v, "\n")
  IQROutlier(datos[[v]])
})
```

```{r}
library(ggplot2)

variable <- "Age"

boxplot(datos[, variable])
boxplot.stats(datos[, variable])$out
# Crear un boxplot
ggplot(datos, aes(y = get(variable))) +
  geom_boxplot(fill = "skyblue", color = "black") +
  labs(title = paste0("Boxplot de ", variable)) +
  theme_minimal()
```

```{r}
variable <- "Age"
valorEscalado <- scale(datos[, variable])
hist(valorEscalado)
```
```{r}
ggplot(data.frame(valor = valorEscalado), aes(x = valor)) +
  geom_histogram(binwidth = 0.5, fill = "skyblue", color = "black") +  # Histograma
  geom_vline(xintercept = c(3, -3), linetype = "dashed", color = "red", size = 1) + # Líneas horizontales
  theme_minimal()
```

Preprocessing multivariante

```{r}
#library(dplyr)

train <- read.csv("train.csv", header = TRUE, sep = ",")
test  <- read.csv("test.csv", header = TRUE, sep = ",")
datos <- bind_rows(train, test)

varNum <- names(datos)[sapply(datos, is.numeric)]
datos_num <- datos[, varNum]
summary(datos_num)




center <- colMeans(datos_num, na.rm = TRUE)
cov_matrix <- cov(datos_num, use = "complete.obs")


dist_mahal <- mahalanobis(datos_num, center, cov_matrix)

umbral <- qchisq(0.999, df = ncol(datos_num))


outliers_mahal <- which(dist_mahal > umbral)
cat("Número de outliers multivariantes detectados:", length(outliers_mahal), "\n")


summary(dist_mahal)



#library(ggplot2)

ggplot(data.frame(dist_mahal), aes(x = 1:length(dist_mahal), y = dist_mahal)) +
  geom_point(color = "grey40") +
  geom_hline(yintercept = umbral, color = "red", linetype = "dashed") +
  labs(title = "Distancia de Mahalanobis", x = "Observación", y = "Distancia") +
  theme_minimal()




library(FactoMineR)
library(factoextra)
library(ggplot2)

# PCA
pca <- PCA(datos_num, scale.unit = TRUE, graph = FALSE)

# Crear dataframe con coordenadas
coords <- as.data.frame(pca$ind$coord)
coords$Outlier <- factor(ifelse(1:nrow(datos_num) %in% outliers_mahal, "Outlier", "Normal"))

# Gráfico manual con ggplot2 (sin errores de color)
ggplot(coords, aes(x = Dim.1, y = Dim.2, color = Outlier)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("blue", "red")) +
  labs(title = "PCA - Outliers multivariantes (rojo = outliers)",
       x = "Componente principal 1",
       y = "Componente principal 2") +
  theme_minimal()




datos$Outlier_Mahalanobis <- FALSE
datos$Outlier_Mahalanobis[outliers_mahal] <- TRUE

write.csv(datos, "datos_outliers_multivariantes.csv", row.names = FALSE)
```
